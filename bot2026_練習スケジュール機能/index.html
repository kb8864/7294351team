<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 15px; color: #333; padding-top: 110px; }
    .header-bar { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 10px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; }
    .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .app-title { font-weight: bold; color: #555; font-size: 1.1em; }
    select#month-filter { padding: 6px 10px; font-size: 1.1em; font-weight: bold; color: #00B900; background: #fff; border: 2px solid #00B900; border-radius: 8px; outline: none; }
    
    .export-btn-area { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    
    /* é€šå¸¸ãƒœã‚¿ãƒ³ï¼ˆç·‘ï¼‰ */
    .export-btn { background-color: #00B900; color: white; border: none; padding: 8px 15px; font-size: 0.9em; font-weight: bold; border-radius: 20px; cursor: pointer; display: inline-flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-decoration: none; }
    .export-btn:active { background-color: #009000; box-shadow: none; transform: translateY(2px); }
    
    /* ç¥­ã‚Šãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
    .festival-btn { background-color: #FF9900; color: white; border: none; padding: 8px 15px; font-size: 0.9em; font-weight: bold; border-radius: 20px; cursor: pointer; display: inline-flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-decoration: none; }
    .festival-btn:active { background-color: #E68A00; box-shadow: none; transform: translateY(2px); }

    .export-icon { margin-right: 5px; font-size: 1.2em; }
    .calendar-container { background: white; border-radius: 8px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-header { font-size: 0.8em; color: #555; background: #f9f9f9; padding: 5px 0; text-align: center; font-weight: bold; }
    .cal-header.sun { color: #d00; background: #fff0f0; } .cal-header.sat { color: #00d; background: #f0f0ff; }
    .cal-cell { background: white; min-height: 85px; padding: 2px; display: flex; flex-direction: column; }
    .cal-cell.today { background-color: #eafbea; } .cal-cell.empty { background: #f8f8f8; }
    .day-num { font-size: 0.9em; font-weight: bold; text-align: center; margin-bottom: 2px; color: #333; }
    .cal-event-block { background: #00B900; color: white; border-radius: 3px; padding: 3px 2px; margin-top: 2px; font-size: 0.65em; line-height: 1.2; overflow: hidden; }
    .cal-time { font-weight: bold; display: block; border-bottom: 1px solid rgba(255,255,255,0.3); margin-bottom: 1px;}
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { color: red; background: #ffe; padding: 10px; text-align: center; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 12px; padding: 25px 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-title { font-weight: bold; font-size: 1.2em; margin-bottom: 15px; color: #333; }
    .modal-text { font-size: 1em; color: #555; margin-bottom: 25px; line-height: 1.5; }
    .modal-buttons { display: flex; justify-content: space-around; gap: 10px; }
    .modal-btn { padding: 12px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 1em; width: 48%; }
    .btn-cancel { background: #eee; color: #333; }
    .btn-ok { background: #00B900; color: white; }
    .btn-close { width: 100%; background: #555; color: white; margin-top: 10px; }
    .status-sending { color: #555; font-weight: bold; }
    .success-msg { color: #00B900; font-weight: bold; font-size: 1.2em; }
  </style>
</head>
<body>

  <div id="main-view">
    <div class="header-bar">
      <div class="header-top-row">
        <div class="app-title">ğŸ“… ç·´ç¿’æ—¥ç¨‹</div>
        <select id="month-filter" onchange="changeMonth()"></select>
      </div>
      <div class="export-btn-area">
        <button id="btn-festival" class="festival-btn" onclick="openConfirmModal('festival')">
          <span class="export-icon">ğŸ•ºğŸ’ƒ</span>ç¥­ã‚Šã ã‘å…¨ç™»éŒ²ã™ã‚‹
        </button>
        <button id="btn-normal" class="export-btn" onclick="openConfirmModal('normal')">
          <span class="export-icon">ğŸ“¥</span>ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²
        </button>
      </div>
    </div>
    <div id="main-container">
      <div class="loading">èª­ã¿è¾¼ã¿ä¸­â€¦ã¡ã‚‡ã„ã¨ãŠå¾…ã¡ã‚’ğŸŒ€</div>
    </div>
  </div>

  <div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
      <div id="modal-step-confirm">
        <div class="modal-title">ç™»éŒ²ã®ç¢ºèª</div>
        <div class="modal-text" id="confirm-msg"></div>
        <div class="modal-buttons">
          <button class="modal-btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-ok" onclick="executeDownload()">OK</button>
        </div>
      </div>
      <div id="modal-step-status" style="display:none;">
        <div class="modal-title" id="status-title">ğŸ”„ é€ä¿¡ä¸­</div>
        <div class="modal-text">
          <div id="status-msg" class="status-sending">ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...</div>
          <br>
          <small id="status-sub">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã—ã¾ã™ã€‚</small>
        </div>
        <div id="status-complete-area" style="display:none;">
           <div class="success-msg">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
           <br>
           <small>ãŠç–²ã‚Œæ§˜ã§ã—ãŸ<br>ã€Œé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã€ã‚’æŠ¼ã—ã¦ç”»é¢ã‚’é–‰ã˜ã¦ãã ã•ã„</small>
           <button class="modal-btn btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allEventsData = [];
    let currentSelectedMonth = 1;
    let currentDownloadType = 'normal'; // 'normal' or 'festival'
    const DEPLOY_URL = "<?= deployUrl ?>";
    let isProcessing = false;

    window.onload = function() {
      setupMonthOptions();
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(showError)
        .getCalendarEvents();
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible' && isProcessing) {
          showCompleteState();
          isProcessing = false; 
        }
      });
    };

    function onSuccess(result) {
      if (result.error) { showError(result); return; }
      allEventsData = result.events;
      render();
    }

    function setupMonthOptions() {
      const select = document.getElementById('month-filter');
      const today = new Date();
      currentSelectedMonth = today.getMonth() + 1;
      
      // 1æœˆãªã‚‰2æœˆã‚’é¸æŠ
      if (currentSelectedMonth < 2) currentSelectedMonth = 2;

      // 2æœˆã‹ã‚‰12æœˆã¾ã§ç”Ÿæˆ
      for (let i = 2; i <= 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + 'æœˆ';
        select.appendChild(option);
      }
      select.value = currentSelectedMonth; 
    }

    function changeMonth() {
      currentSelectedMonth = parseInt(document.getElementById('month-filter').value);
      render();
    }

    function render() {
      const container = document.getElementById('main-container');
      container.innerHTML = "";
      
      updateButtonVisibility();

      const filteredEvents = allEventsData.filter(e => e.month == currentSelectedMonth);
      renderCalendarView(container, filteredEvents);
      window.scrollTo(0, 0);
    }

    function updateButtonVisibility() {
      const today = new Date();
      const realMonth = today.getMonth() + 1; // ç¾å®Ÿä¸–ç•Œã®æœˆ
      const nextMonth = realMonth + 1;

      const btnNormal = document.getElementById('btn-normal');
      const btnFestival = document.getElementById('btn-festival');

      // ç¥­ã‚Šãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤º
      btnFestival.style.display = 'inline-flex';

      // é€šå¸¸ãƒœã‚¿ãƒ³ã¯ã€Œå½“æœˆã€ã€Œç¿Œæœˆã€ã€Œ12æœˆã€ã®ã¿è¡¨ç¤º
      let showNormal = false;
      if (currentSelectedMonth === realMonth) showNormal = true;
      if (currentSelectedMonth === nextMonth) showNormal = true;
      if (currentSelectedMonth === 12) showNormal = true;
      
      if (showNormal) {
        btnNormal.style.display = 'inline-flex';
      } else {
        btnNormal.style.display = 'none';
      }
    }

    function openConfirmModal(type) {
      currentDownloadType = type;
      let targetCount = 0;

      if (type === 'festival') {
        // â˜…ç¥­ã‚Šãƒ¢ãƒ¼ãƒ‰ï¼š2æœˆã€œ12æœˆã®ãƒŸã‚«ãƒ³è‰²(6)ã®å…¨ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const festivalEvents = allEventsData.filter(e => {
          return e.colorId === '6' && e.month >= 2 && e.month <= 12;
        });
        targetCount = festivalEvents.length;
        
        if (targetCount === 0) {
           alert("2æœˆã‹ã‚‰12æœˆã¾ã§ã®æœŸé–“ã«ã€ç™»éŒ²ã™ã‚‹ã€Œç¥­ã‚Šã€ã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
           return;
        }
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šç¾åœ¨ã®æœˆã®ä»¶æ•°
        const filteredEvents = allEventsData.filter(e => e.month == currentSelectedMonth);
        targetCount = filteredEvents.length;

        if (targetCount === 0) {
          alert(currentSelectedMonth + "æœˆã«ã¯ç™»éŒ²ã™ã‚‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }
      }
      
      document.getElementById('modal-step-confirm').style.display = 'block';
      document.getElementById('modal-step-status').style.display = 'none';
      isProcessing = false;
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      // â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡ºã—åˆ†ã‘
      let msg = "";
      if (type === 'festival') {
        msg = "2æœˆã‹ã‚‰12æœˆã®ç¥­ã‚Šã®äºˆå®š(" + targetCount + "ä»¶)ã‚’<br>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ";
      } else {
        msg = currentSelectedMonth + "æœˆã®äºˆå®š(" + targetCount + "ä»¶)ã‚’<br>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ";
      }

      if (isIOS) msg += "<br><br><small>ã€é‡è¦ã€‘<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠã™ã‚‹ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰<br>ã”è‡ªèº«ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</small>";
      
      document.getElementById('confirm-msg').innerHTML = msg;
      document.getElementById('custom-modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('custom-modal').style.display = 'none';
    }

    function executeDownload() {
      isProcessing = true;
      document.getElementById('modal-step-confirm').style.display = 'none';
      document.getElementById('modal-step-status').style.display = 'block';
      document.getElementById('status-title').innerText = "ğŸ”„ é€ä¿¡ä¸­";
      document.getElementById('status-msg').style.display = 'block';
      document.getElementById('status-sub').style.display = 'block';
      document.getElementById('status-complete-area').style.display = 'none';

      // URLã«ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã™
      const downloadUrl = DEPLOY_URL + "?month=" + currentSelectedMonth + "&type=" + currentDownloadType + "&ver=" + new Date().getTime();
      window.open(downloadUrl, '_top');
    }

    function showCompleteState() {
      document.getElementById('status-title').innerText = "âœ… é€ä¿¡å®Œäº†";
      document.getElementById('status-msg').style.display = 'none';
      document.getElementById('status-sub').style.display = 'none';
      document.getElementById('status-complete-area').style.display = 'block';
    }

    function renderCalendarView(container, events) {
      let targetYear = new Date().getFullYear();
      if (events.length > 0) targetYear = new Date(events[0].startTime).getFullYear();
      else if (currentSelectedMonth < new Date().getMonth() + 1) targetYear++;

      const firstDay = new Date(targetYear, currentSelectedMonth - 1, 1);
      const lastDay = new Date(targetYear, currentSelectedMonth, 0); 
      const startDayOfWeek = firstDay.getDay(); 
      const totalDays = lastDay.getDate();

      const calWrapper = document.createElement('div');
      calWrapper.className = 'calendar-container';
      let html = `<div class="calendar-grid">`;
      const weeks = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      weeks.forEach((w, i) => {
        const colorClass = i === 0 ? 'sun' : (i === 6 ? 'sat' : '');
        html += `<div class="cal-header ${colorClass}">${w}</div>`;
      });
      for (let i = 0; i < startDayOfWeek; i++) { html += `<div class="cal-cell empty"></div>`; }
      for (let d = 1; d <= totalDays; d++) {
        const daysEvents = events.filter(e => e.day == d);
        const isToday = (new Date().getDate() == d && new Date().getMonth() + 1 == currentSelectedMonth);
        const todayClass = isToday ? 'today' : '';
        let eventHtml = '';
        daysEvents.forEach(e => {
            let simpleTime = e.time.replace(':00','').replace(':00','');
            if(simpleTime === "çµ‚æ—¥") simpleTime = "â—†";
            eventHtml += `<div class="cal-event-block"><span class="cal-time">${simpleTime}</span><span>${e.title}</span></div>`;
        });
        html += `<div class="cal-cell ${todayClass}"><div class="day-num">${d}</div>${eventHtml}</div>`;
      }
      html += `</div>`;
      calWrapper.innerHTML = html;
      container.appendChild(calWrapper);
      calWrapper.style.display = 'block'; 
    }

    function showError(e) { document.getElementById('main-container').innerHTML = `<div class="error">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`; }
  </script>
</body>
</html>